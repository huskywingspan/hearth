{"version":3,"file":"RoomPage-CVJrcVW7.js","sources":["../../src/hooks/useMessages.ts","../../src/hooks/usePresence.ts","../../src/hooks/useTimeSync.ts","../../src/components/campfire/MessageBubble.tsx","../../src/components/campfire/MessageList.tsx","../../src/components/campfire/MessageInput.tsx","../../src/components/campfire/MumblingIndicator.tsx","../../src/components/ui/Avatar.tsx","../../src/components/campfire/PresenceBar.tsx","../../src/components/campfire/CampfireRoom.tsx","../../src/pages/RoomPage.tsx"],"sourcesContent":["import { useEffect, useState, useCallback } from 'react';\r\nimport pb from '@/lib/pocketbase';\r\nimport { useReconnect } from './useReconnect';\r\nimport { MESSAGE_PAGE_SIZE } from '@/lib/constants';\r\n\r\nexport interface Message {\r\n  id: string;\r\n  text: string;\r\n  room: string;\r\n  author: string;\r\n  expires_at: string;\r\n  created: string;\r\n  expand?: {\r\n    author?: { display_name: string; avatar_url: string };\r\n  };\r\n}\r\n\r\nexport function useMessages(roomId: string) {\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  // Fetch current messages for this room\r\n  const fetchMessages = useCallback(async () => {\r\n    if (!roomId) return;\r\n    try {\r\n      const result = await pb\r\n        .collection('messages')\r\n        .getList<Message>(1, MESSAGE_PAGE_SIZE, {\r\n          filter: `room = \"${roomId}\"`,\r\n          sort: 'created',\r\n          expand: 'author',\r\n          requestKey: `messages-${roomId}`,\r\n        });\r\n      setMessages(result.items);\r\n    } catch (err) {\r\n      console.error('Failed to fetch messages:', err);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [roomId]);\r\n\r\n  // Initial fetch\r\n  useEffect(() => {\r\n    setIsLoading(true);\r\n    fetchMessages();\r\n  }, [fetchMessages]);\r\n\r\n  // Real-time subscription\r\n  useEffect(() => {\r\n    if (!roomId) return;\r\n\r\n    const unsubPromise = pb\r\n      .collection('messages')\r\n      .subscribe<Message>('*', (data) => {\r\n        if (data.record.room !== roomId) return;\r\n\r\n        switch (data.action) {\r\n          case 'create':\r\n            setMessages((prev) => [...prev, data.record]);\r\n            break;\r\n          case 'update':\r\n            setMessages((prev) =>\r\n              prev.map((m) => (m.id === data.record.id ? data.record : m))\r\n            );\r\n            break;\r\n          case 'delete':\r\n            // Server GC deleted an expired message — remove from state\r\n            setMessages((prev) =>\r\n              prev.filter((m) => m.id !== data.record.id)\r\n            );\r\n            break;\r\n        }\r\n      });\r\n\r\n    return () => {\r\n      unsubPromise.then((unsub) => unsub());\r\n    };\r\n  }, [roomId]);\r\n\r\n  // Reconnect: re-fetch everything (missed events are not replayed per R-004)\r\n  useReconnect(fetchMessages);\r\n\r\n  // Remove a message client-side (e.g., after animationend)\r\n  const removeMessage = useCallback((id: string) => {\r\n    setMessages((prev) => prev.filter((m) => m.id !== id));\r\n  }, []);\r\n\r\n  // Optimistic send\r\n  const sendMessage = useCallback(\r\n    async (text: string) => {\r\n      const tempId = `temp-${Date.now()}`;\r\n      const optimistic: Message = {\r\n        id: tempId,\r\n        text,\r\n        room: roomId,\r\n        author: pb.authStore.record?.id ?? '',\r\n        expires_at: new Date(Date.now() + 300_000).toISOString(), // 5 min default\r\n        created: new Date().toISOString(),\r\n      };\r\n\r\n      // Immediately add to state (optimistic UI)\r\n      setMessages((prev) => [...prev, optimistic]);\r\n\r\n      try {\r\n        const real = await pb.collection('messages').create<Message>({\r\n          text,\r\n          room: roomId,\r\n          // Server enforces expires_at via TTL field\r\n        });\r\n        // Replace optimistic with real record\r\n        setMessages((prev) =>\r\n          prev.map((m) => (m.id === tempId ? real : m))\r\n        );\r\n      } catch {\r\n        // Revert on failure\r\n        setMessages((prev) => prev.filter((m) => m.id !== tempId));\r\n        // TODO: show error toast via toast context\r\n      }\r\n    },\r\n    [roomId]\r\n  );\r\n\r\n  return { messages, isLoading, sendMessage, removeMessage };\r\n}\r\n","import { useEffect, useState } from 'react';\r\nimport pb from '@/lib/pocketbase';\r\nimport { HEARTBEAT_INTERVAL_MS, PRESENCE_POLL_INTERVAL_MS } from '@/lib/constants';\r\n\r\nexport interface PresenceEntry {\r\n  user_id: string;\r\n  display_name: string;\r\n  last_seen: number;\r\n}\r\n\r\nexport function usePresence(roomId: string) {\r\n  const [presentUsers, setPresentUsers] = useState<PresenceEntry[]>([]);\r\n\r\n  // Send heartbeat every 30 seconds\r\n  useEffect(() => {\r\n    if (!roomId) return;\r\n\r\n    const beat = () => {\r\n      pb.send('/api/hearth/presence/heartbeat', {\r\n        method: 'POST',\r\n        body: { room_id: roomId },\r\n      }).catch(() => {\r\n        /* offline — will retry on reconnect */\r\n      });\r\n    };\r\n\r\n    beat(); // Immediate first heartbeat\r\n    const interval = setInterval(beat, HEARTBEAT_INTERVAL_MS);\r\n    return () => clearInterval(interval);\r\n  }, [roomId]);\r\n\r\n  // Poll presence list\r\n  useEffect(() => {\r\n    if (!roomId) return;\r\n\r\n    const fetchPresence = async () => {\r\n      try {\r\n        const data = await pb.send(`/api/hearth/presence/${roomId}`, {\r\n          method: 'GET',\r\n        });\r\n        setPresentUsers(\r\n          (data as { users?: PresenceEntry[] }).users ?? []\r\n        );\r\n      } catch {\r\n        /* noop */\r\n      }\r\n    };\r\n\r\n    fetchPresence();\r\n    const interval = setInterval(fetchPresence, PRESENCE_POLL_INTERVAL_MS);\r\n    return () => clearInterval(interval);\r\n  }, [roomId]);\r\n\r\n  return { presentUsers };\r\n}\r\n","import { useEffect, useRef, useCallback } from 'react';\r\n\r\n/**\r\n * Calculates offset between client clock and server clock\r\n * using the Date header from PocketBase API responses.\r\n *\r\n * serverTime ≈ clientTime + offset\r\n *\r\n * Accuracy: ~500ms (sufficient for visual fading).\r\n */\r\nexport function useTimeSync() {\r\n  const offsetMs = useRef(0);\r\n\r\n  useEffect(() => {\r\n    async function sync() {\r\n      const before = Date.now();\r\n      const response = await fetch(\r\n        (import.meta.env.VITE_PB_URL || '') + '/api/health'\r\n      );\r\n      const after = Date.now();\r\n      const rtt = after - before;\r\n\r\n      const serverDateStr = response.headers.get('Date');\r\n      if (!serverDateStr) return;\r\n\r\n      const serverTime = new Date(serverDateStr).getTime();\r\n      // Estimate: server header sent at the midpoint of RTT\r\n      const estimatedClientTimeAtServer = before + rtt / 2;\r\n      offsetMs.current = serverTime - estimatedClientTimeAtServer;\r\n    }\r\n\r\n    sync();\r\n    // Re-sync every 5 minutes\r\n    const interval = setInterval(sync, 5 * 60 * 1000);\r\n    return () => clearInterval(interval);\r\n  }, []);\r\n\r\n  /** Get the current server time (client clock + measured offset). */\r\n  const getServerNow = useCallback(() => {\r\n    return Date.now() + offsetMs.current;\r\n  }, []);\r\n\r\n  return { getServerNow, offsetMs: offsetMs.current };\r\n}\r\n","import { useCallback, type CSSProperties } from 'react';\r\nimport { useTimeSync } from '@/hooks/useTimeSync';\r\nimport type { Message } from '@/hooks/useMessages';\r\n\r\ninterface Props {\r\n  message: Message;\r\n  onGone: (id: string) => void;\r\n}\r\n\r\n/**\r\n * Individual fading message in the Campfire.\r\n *\r\n * Architecture (from R-008):\r\n * - ONE CSS animation per message via custom properties\r\n * - Negative animation-delay starts mid-fade for old messages on page load\r\n * - animationend fires → remove from React state → DOM cleanup\r\n * - content-visibility: auto handled by .campfire-message class\r\n * - NO will-change (browser auto-promotes animated elements)\r\n */\r\nexport function MessageBubble({ message, onGone }: Props) {\r\n  const { getServerNow } = useTimeSync();\r\n\r\n  const isOptimistic = message.id.startsWith('temp-');\r\n  const serverNow = getServerNow();\r\n\r\n  // Calculate animation timing\r\n  const createdMs = new Date(message.created).getTime();\r\n  const expiresMs = new Date(message.expires_at).getTime();\r\n  const fadeDuration = (expiresMs - createdMs) / 1000; // Total TTL in seconds\r\n  const ageSeconds = (serverNow - createdMs) / 1000;\r\n  const ageOffset = -ageSeconds; // Negative = start mid-fade\r\n\r\n  // Already expired — don't render\r\n  if (ageSeconds >= fadeDuration) return null;\r\n\r\n  const handleAnimationEnd = useCallback(\r\n    (e: React.AnimationEvent) => {\r\n      // Only handle the fade animation, not the float-in entrance\r\n      if (e.animationName === 'campfire-fade') {\r\n        onGone(message.id);\r\n      }\r\n    },\r\n    [message.id, onGone]\r\n  );\r\n\r\n  const style: CSSProperties = {\r\n    '--fade-duration': `${fadeDuration}s`,\r\n    '--age-offset': `${ageOffset}s`,\r\n  } as CSSProperties;\r\n\r\n  const authorName =\r\n    message.expand?.author?.display_name ?? 'Wanderer';\r\n\r\n  return (\r\n    <div\r\n      className=\"campfire-message animate-float-in\"\r\n      style={style}\r\n      data-optimistic={isOptimistic || undefined}\r\n      onAnimationEnd={handleAnimationEnd}\r\n    >\r\n      <div className=\"flex items-start gap-3 p-3 rounded-[var(--radius-lg)]\">\r\n        <span className=\"font-medium text-sm text-[var(--color-accent-amber)] shrink-0\">\r\n          {authorName}\r\n        </span>\r\n        <span className=\"text-[var(--color-text-primary)] text-base break-words min-w-0\">\r\n          {message.text}\r\n        </span>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { useEffect, useRef } from 'react';\r\nimport { MessageBubble } from './MessageBubble';\r\nimport type { Message } from '@/hooks/useMessages';\r\n\r\ninterface Props {\r\n  messages: Message[];\r\n  onMessageGone: (id: string) => void;\r\n}\r\n\r\n/**\r\n * Scrollable message list with auto-scroll anchoring.\r\n * Auto-scrolls to bottom on new messages (if user hasn't scrolled up).\r\n */\r\nexport function MessageList({ messages, onMessageGone }: Props) {\r\n  const listRef = useRef<HTMLDivElement>(null);\r\n  const shouldAutoScroll = useRef(true);\r\n\r\n  // Auto-scroll to bottom on new messages\r\n  useEffect(() => {\r\n    const el = listRef.current;\r\n    if (!el || !shouldAutoScroll.current) return;\r\n    el.scrollTop = el.scrollHeight;\r\n  }, [messages.length]);\r\n\r\n  // Track whether user has scrolled up\r\n  const handleScroll = () => {\r\n    const el = listRef.current;\r\n    if (!el) return;\r\n    const threshold = 100; // px from bottom\r\n    shouldAutoScroll.current =\r\n      el.scrollHeight - el.scrollTop - el.clientHeight < threshold;\r\n  };\r\n\r\n  return (\r\n    <div\r\n      ref={listRef}\r\n      onScroll={handleScroll}\r\n      className=\"flex-1 overflow-y-auto overscroll-contain p-4 space-y-2\"\r\n    >\r\n      {messages.length === 0 ? (\r\n        <div className=\"flex items-center justify-center h-full text-[var(--color-text-muted)] text-sm\">\r\n          The campfire is quiet. Say something...\r\n        </div>\r\n      ) : (\r\n        messages.map((msg) => (\r\n          <MessageBubble\r\n            key={msg.id}\r\n            message={msg}\r\n            onGone={onMessageGone}\r\n          />\r\n        ))\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import { useState, useCallback, useRef, type FormEvent } from 'react';\r\nimport { Button } from '@/components/ui/Button';\r\nimport { TYPING_DEBOUNCE_MS } from '@/lib/constants';\r\n\r\ninterface Props {\r\n  onSend: (text: string) => void;\r\n  onTypingStart?: () => void;\r\n  onTypingStop?: () => void;\r\n  disabled?: boolean;\r\n}\r\n\r\n/**\r\n * Message compose input — warm styling, pillow send button.\r\n * Debounced typing indicator emission.\r\n */\r\nexport function MessageInput({\r\n  onSend,\r\n  onTypingStart,\r\n  onTypingStop,\r\n  disabled = false,\r\n}: Props) {\r\n  const [text, setText] = useState('');\r\n  const typingTimeoutRef = useRef<ReturnType<typeof setTimeout>>(undefined);\r\n\r\n  const handleSubmit = useCallback(\r\n    (e: FormEvent) => {\r\n      e.preventDefault();\r\n      const trimmed = text.trim();\r\n      if (!trimmed) return;\r\n      onSend(trimmed);\r\n      setText('');\r\n      // Clear typing indicator\r\n      if (typingTimeoutRef.current) {\r\n        clearTimeout(typingTimeoutRef.current);\r\n      }\r\n      onTypingStop?.();\r\n    },\r\n    [text, onSend, onTypingStop]\r\n  );\r\n\r\n  const handleChange = useCallback(\r\n    (value: string) => {\r\n      setText(value);\r\n\r\n      // Typing indicator debounce\r\n      if (value.trim()) {\r\n        onTypingStart?.();\r\n        if (typingTimeoutRef.current) {\r\n          clearTimeout(typingTimeoutRef.current);\r\n        }\r\n        typingTimeoutRef.current = setTimeout(() => {\r\n          onTypingStop?.();\r\n        }, TYPING_DEBOUNCE_MS);\r\n      } else {\r\n        onTypingStop?.();\r\n      }\r\n    },\r\n    [onTypingStart, onTypingStop]\r\n  );\r\n\r\n  const handleKeyDown = useCallback(\r\n    (e: React.KeyboardEvent) => {\r\n      // Enter sends, Shift+Enter for newline (not yet multiline)\r\n      if (e.key === 'Enter' && !e.shiftKey) {\r\n        e.preventDefault();\r\n        const trimmed = text.trim();\r\n        if (!trimmed) return;\r\n        onSend(trimmed);\r\n        setText('');\r\n        if (typingTimeoutRef.current) {\r\n          clearTimeout(typingTimeoutRef.current);\r\n        }\r\n        onTypingStop?.();\r\n      }\r\n    },\r\n    [text, onSend, onTypingStop]\r\n  );\r\n\r\n  return (\r\n    <form\r\n      onSubmit={handleSubmit}\r\n      className=\"flex items-center gap-3 p-4 border-t border-[var(--color-bg-elevated)]\"\r\n    >\r\n      <input\r\n        type=\"text\"\r\n        value={text}\r\n        onChange={(e) => handleChange(e.target.value)}\r\n        onKeyDown={handleKeyDown}\r\n        placeholder=\"Say something...\"\r\n        disabled={disabled}\r\n        className={[\r\n          'flex-1 bg-[var(--color-bg-input)]',\r\n          'text-[var(--color-text-primary)]',\r\n          'placeholder:text-[var(--color-text-muted)]',\r\n          'rounded-[var(--radius-pill)]',\r\n          'border-none px-5 py-2.5',\r\n          'transition-shadow duration-[var(--duration-normal)]',\r\n          'focus:outline-none focus:shadow-[var(--shadow-glow)]',\r\n        ].join(' ')}\r\n      />\r\n      <Button\r\n        type=\"submit\"\r\n        variant=\"primary\"\r\n        size=\"md\"\r\n        disabled={disabled || !text.trim()}\r\n      >\r\n        Send\r\n      </Button>\r\n    </form>\r\n  );\r\n}\r\n","interface Props {\r\n  typingUsers: string[];\r\n}\r\n\r\n/**\r\n * \"Mumbling\" typing indicator (K-015).\r\n * Blurred waveform / abstract scribbles indicating rhythm — not \"User is typing...\"\r\n * Per master plan: warmth over mechanical status text.\r\n */\r\nexport function MumblingIndicator({ typingUsers }: Props) {\r\n  if (typingUsers.length === 0) return null;\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-2 px-4 py-2 text-[var(--color-text-muted)] text-sm\">\r\n      <div className=\"flex gap-0.5 items-end\">\r\n        {/* Three blurred \"scribble\" bars that undulate */}\r\n        <span className=\"mumble-bar\" style={{ animationDelay: '0ms' }} />\r\n        <span className=\"mumble-bar\" style={{ animationDelay: '150ms' }} />\r\n        <span className=\"mumble-bar\" style={{ animationDelay: '300ms' }} />\r\n      </div>\r\n      <span className=\"blur-[1px] select-none\">\r\n        {typingUsers.length === 1\r\n          ? `${typingUsers[0]} is thinking...`\r\n          : `${typingUsers.length} people murmuring...`}\r\n      </span>\r\n    </div>\r\n  );\r\n}\r\n","interface AvatarProps {\r\n  name: string;\r\n  src?: string;\r\n  size?: 'sm' | 'md' | 'lg';\r\n  active?: boolean;\r\n  className?: string;\r\n}\r\n\r\nconst sizeClasses = {\r\n  sm: 'w-7 h-7 text-xs',\r\n  md: 'w-10 h-10 text-sm',\r\n  lg: 'w-14 h-14 text-base',\r\n} as const;\r\n\r\n/**\r\n * Rounded avatar with initials fallback.\r\n * Ember glow ring when user is active/speaking.\r\n */\r\nexport function Avatar({\r\n  name,\r\n  src,\r\n  size = 'md',\r\n  active = false,\r\n  className = '',\r\n}: AvatarProps) {\r\n  const initials = name\r\n    .split(' ')\r\n    .map((w) => w[0])\r\n    .join('')\r\n    .slice(0, 2)\r\n    .toUpperCase();\r\n\r\n  // Deterministic color from name (warm palette)\r\n  const hue = name.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0) % 40 + 15; // 15-55 (warm)\r\n\r\n  return (\r\n    <div\r\n      className={[\r\n        'rounded-full flex items-center justify-center font-medium select-none',\r\n        'transition-shadow duration-[var(--duration-normal)]',\r\n        sizeClasses[size],\r\n        active ? 'ring-2 ring-[var(--color-accent-amber)] shadow-[var(--shadow-glow)]' : '',\r\n        className,\r\n      ].join(' ')}\r\n      style={\r\n        src\r\n          ? undefined\r\n          : { backgroundColor: `hsl(${hue}, 40%, 35%)`, color: `hsl(${hue}, 30%, 80%)` }\r\n      }\r\n      title={name}\r\n    >\r\n      {src ? (\r\n        <img\r\n          src={src}\r\n          alt={name}\r\n          className=\"w-full h-full rounded-full object-cover\"\r\n        />\r\n      ) : (\r\n        initials\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import type { PresenceEntry } from '@/hooks/usePresence';\r\nimport { Avatar } from '@/components/ui/Avatar';\r\n\r\ninterface Props {\r\n  users: PresenceEntry[];\r\n  roomName?: string;\r\n}\r\n\r\n/**\r\n * Who's-here bar at the top of a Campfire room.\r\n * Stacked avatars, count, overflow indicator.\r\n */\r\nexport function PresenceBar({ users, roomName }: Props) {\r\n  return (\r\n    <div className=\"flex items-center gap-3 px-4 py-3 border-b border-[var(--color-bg-elevated)]\">\r\n      {roomName && (\r\n        <h2 className=\"font-display text-lg text-[var(--color-text-primary)] mr-auto\">\r\n          {roomName}\r\n        </h2>\r\n      )}\r\n      <span className=\"text-[var(--color-text-muted)] text-sm\">\r\n        {users.length} {users.length === 1 ? 'person' : 'people'} here\r\n      </span>\r\n      <div className=\"flex -space-x-2\">\r\n        {users.slice(0, 8).map((u) => (\r\n          <Avatar\r\n            key={u.user_id}\r\n            name={u.display_name}\r\n            className=\"ring-2 ring-[var(--color-bg-primary)]\"\r\n            size=\"sm\"\r\n          />\r\n        ))}\r\n        {users.length > 8 && (\r\n          <span className=\"text-[var(--color-text-muted)] text-xs ml-2 self-center\">\r\n            +{users.length - 8}\r\n          </span>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { useMessages } from '@/hooks/useMessages';\r\nimport { usePresence } from '@/hooks/usePresence';\r\nimport { MessageList } from './MessageList';\r\nimport { MessageInput } from './MessageInput';\r\nimport { MumblingIndicator } from './MumblingIndicator';\r\nimport { PresenceBar } from './PresenceBar';\r\n\r\ninterface Props {\r\n  roomId: string;\r\n  roomName?: string;\r\n}\r\n\r\n/**\r\n * Full Campfire room container — presence bar, message list, input.\r\n * Composes all campfire sub-components.\r\n */\r\nexport function CampfireRoom({ roomId, roomName }: Props) {\r\n  const { messages, isLoading, sendMessage, removeMessage } =\r\n    useMessages(roomId);\r\n  const { presentUsers } = usePresence(roomId);\r\n\r\n  // TODO: Typing indicator state (future: custom topic subscription)\r\n  const typingUsers: string[] = [];\r\n\r\n  return (\r\n    <div className=\"flex flex-col h-full animate-slide-in\">\r\n      <PresenceBar users={presentUsers} roomName={roomName} />\r\n\r\n      {isLoading ? (\r\n        <div className=\"flex-1 flex items-center justify-center\">\r\n          <div\r\n            className=\"w-8 h-8 rounded-full animate-warm-pulse\"\r\n            style={{\r\n              background:\r\n                'radial-gradient(circle, var(--color-accent-amber), transparent 70%)',\r\n            }}\r\n          />\r\n        </div>\r\n      ) : (\r\n        <MessageList messages={messages} onMessageGone={removeMessage} />\r\n      )}\r\n\r\n      <MumblingIndicator typingUsers={typingUsers} />\r\n      <MessageInput onSend={sendMessage} />\r\n    </div>\r\n  );\r\n}\r\n","import { useParams } from 'react-router-dom';\r\nimport { useEffect, useState } from 'react';\r\nimport { Shell } from '@/components/layout/Shell';\r\nimport { CampfireRoom } from '@/components/campfire/CampfireRoom';\r\nimport { Spinner } from '@/components/ui/Spinner';\r\nimport pb from '@/lib/pocketbase';\r\n\r\ninterface Room {\r\n  id: string;\r\n  name: string;\r\n  slug: string;\r\n}\r\n\r\nexport default function RoomPage() {\r\n  const { roomId } = useParams<{ roomId: string }>();\r\n  const [room, setRoom] = useState<Room | null>(null);\r\n  const [error, setError] = useState('');\r\n\r\n  useEffect(() => {\r\n    if (!roomId) return;\r\n\r\n    pb.collection('rooms')\r\n      .getOne<Room>(roomId)\r\n      .then(setRoom)\r\n      .catch(() => setError('Room not found'));\r\n  }, [roomId]);\r\n\r\n  if (error) {\r\n    return (\r\n      <Shell>\r\n        <div className=\"flex items-center justify-center h-full text-[var(--color-alert-clay)]\">\r\n          {error}\r\n        </div>\r\n      </Shell>\r\n    );\r\n  }\r\n\r\n  if (!room || !roomId) {\r\n    return (\r\n      <Shell>\r\n        <div className=\"flex items-center justify-center h-full\">\r\n          <Spinner />\r\n        </div>\r\n      </Shell>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Shell>\r\n      <CampfireRoom roomId={roomId} roomName={room.name} />\r\n    </Shell>\r\n  );\r\n}\r\n"],"names":["useMessages","roomId","messages","setMessages","useState","isLoading","setIsLoading","fetchMessages","useCallback","result","pb","MESSAGE_PAGE_SIZE","err","useEffect","unsubPromise","data","prev","m","unsub","useReconnect","removeMessage","id","sendMessage","text","tempId","optimistic","real","usePresence","presentUsers","setPresentUsers","beat","interval","HEARTBEAT_INTERVAL_MS","fetchPresence","PRESENCE_POLL_INTERVAL_MS","useTimeSync","offsetMs","useRef","sync","before","response","rtt","serverDateStr","serverTime","estimatedClientTimeAtServer","MessageBubble","message","onGone","getServerNow","isOptimistic","serverNow","createdMs","fadeDuration","ageSeconds","ageOffset","handleAnimationEnd","e","style","authorName","jsx","jsxs","MessageList","onMessageGone","listRef","shouldAutoScroll","el","handleScroll","threshold","msg","MessageInput","onSend","onTypingStart","onTypingStop","disabled","setText","typingTimeoutRef","handleSubmit","trimmed","handleChange","value","TYPING_DEBOUNCE_MS","handleKeyDown","Button","MumblingIndicator","typingUsers","sizeClasses","Avatar","name","src","size","active","className","initials","w","hue","acc","c","PresenceBar","users","roomName","u","CampfireRoom","RoomPage","useParams","room","setRoom","error","setError","Shell","Spinner"],"mappings":"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"}