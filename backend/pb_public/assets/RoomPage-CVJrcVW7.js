import{r as n,p as h,M as g,H as b,P as j,j as t,T as y,a as w,S as N}from"./index-BDy1BAFk.js";import{u as S,S as v}from"./Shell-flUMjeiW.js";import{B as E}from"./Button-CcIpWEIN.js";function M(e){const[c,s]=n.useState([]),[l,a]=n.useState(!0),r=n.useCallback(async()=>{if(e)try{const o=await h.collection("messages").getList(1,g,{filter:`room = "${e}"`,sort:"created",expand:"author",requestKey:`messages-${e}`});s(o.items)}catch(o){console.error("Failed to fetch messages:",o)}finally{a(!1)}},[e]);n.useEffect(()=>{a(!0),r()},[r]),n.useEffect(()=>{if(!e)return;const o=h.collection("messages").subscribe("*",u=>{if(u.record.room===e)switch(u.action){case"create":s(i=>[...i,u.record]);break;case"update":s(i=>i.map(d=>d.id===u.record.id?u.record:d));break;case"delete":s(i=>i.filter(d=>d.id!==u.record.id));break}});return()=>{o.then(u=>u())}},[e]),S(r);const m=n.useCallback(o=>{s(u=>u.filter(i=>i.id!==o))},[]),f=n.useCallback(async o=>{const u=`temp-${Date.now()}`,i={id:u,text:o,room:e,author:h.authStore.record?.id??"",expires_at:new Date(Date.now()+3e5).toISOString(),created:new Date().toISOString()};s(d=>[...d,i]);try{const d=await h.collection("messages").create({text:o,room:e});s(x=>x.map(p=>p.id===u?d:p))}catch{s(d=>d.filter(x=>x.id!==u))}},[e]);return{messages:c,isLoading:l,sendMessage:f,removeMessage:m}}function D(e){const[c,s]=n.useState([]);return n.useEffect(()=>{if(!e)return;const l=()=>{h.send("/api/hearth/presence/heartbeat",{method:"POST",body:{room_id:e}}).catch(()=>{})};l();const a=setInterval(l,b);return()=>clearInterval(a)},[e]),n.useEffect(()=>{if(!e)return;const l=async()=>{try{const r=await h.send(`/api/hearth/presence/${e}`,{method:"GET"});s(r.users??[])}catch{}};l();const a=setInterval(l,j);return()=>clearInterval(a)},[e]),{presentUsers:c}}function C(){const e=n.useRef(0);return n.useEffect(()=>{async function s(){const a=Date.now(),r=await fetch("/api/health"),f=Date.now()-a,o=r.headers.get("Date");if(!o)return;const u=new Date(o).getTime(),i=a+f/2;e.current=u-i}s();const l=setInterval(s,300*1e3);return()=>clearInterval(l)},[]),{getServerNow:n.useCallback(()=>Date.now()+e.current,[]),offsetMs:e.current}}function k({message:e,onGone:c}){const{getServerNow:s}=C(),l=e.id.startsWith("temp-"),a=s(),r=new Date(e.created).getTime(),f=(new Date(e.expires_at).getTime()-r)/1e3,o=(a-r)/1e3,u=-o;if(o>=f)return null;const i=n.useCallback(p=>{p.animationName==="campfire-fade"&&c(e.id)},[e.id,c]),d={"--fade-duration":`${f}s`,"--age-offset":`${u}s`},x=e.expand?.author?.display_name??"Wanderer";return t.jsx("div",{className:"campfire-message animate-float-in",style:d,"data-optimistic":l||void 0,onAnimationEnd:i,children:t.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-[var(--radius-lg)]",children:[t.jsx("span",{className:"font-medium text-sm text-[var(--color-accent-amber)] shrink-0",children:x}),t.jsx("span",{className:"text-[var(--color-text-primary)] text-base break-words min-w-0",children:e.text})]})})}function R({messages:e,onMessageGone:c}){const s=n.useRef(null),l=n.useRef(!0);n.useEffect(()=>{const r=s.current;!r||!l.current||(r.scrollTop=r.scrollHeight)},[e.length]);const a=()=>{const r=s.current;if(!r)return;const m=100;l.current=r.scrollHeight-r.scrollTop-r.clientHeight<m};return t.jsx("div",{ref:s,onScroll:a,className:"flex-1 overflow-y-auto overscroll-contain p-4 space-y-2",children:e.length===0?t.jsx("div",{className:"flex items-center justify-center h-full text-[var(--color-text-muted)] text-sm",children:"The campfire is quiet. Say something..."}):e.map(r=>t.jsx(k,{message:r,onGone:c},r.id))})}function T({onSend:e,onTypingStart:c,onTypingStop:s,disabled:l=!1}){const[a,r]=n.useState(""),m=n.useRef(void 0),f=n.useCallback(i=>{i.preventDefault();const d=a.trim();d&&(e(d),r(""),m.current&&clearTimeout(m.current),s?.())},[a,e,s]),o=n.useCallback(i=>{r(i),i.trim()?(c?.(),m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{s?.()},y)):s?.()},[c,s]),u=n.useCallback(i=>{if(i.key==="Enter"&&!i.shiftKey){i.preventDefault();const d=a.trim();if(!d)return;e(d),r(""),m.current&&clearTimeout(m.current),s?.()}},[a,e,s]);return t.jsxs("form",{onSubmit:f,className:"flex items-center gap-3 p-4 border-t border-[var(--color-bg-elevated)]",children:[t.jsx("input",{type:"text",value:a,onChange:i=>o(i.target.value),onKeyDown:u,placeholder:"Say something...",disabled:l,className:["flex-1 bg-[var(--color-bg-input)]","text-[var(--color-text-primary)]","placeholder:text-[var(--color-text-muted)]","rounded-[var(--radius-pill)]","border-none px-5 py-2.5","transition-shadow duration-[var(--duration-normal)]","focus:outline-none focus:shadow-[var(--shadow-glow)]"].join(" ")}),t.jsx(E,{type:"submit",variant:"primary",size:"md",disabled:l||!a.trim(),children:"Send"})]})}function _({typingUsers:e}){return e.length===0?null:t.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 text-[var(--color-text-muted)] text-sm",children:[t.jsxs("div",{className:"flex gap-0.5 items-end",children:[t.jsx("span",{className:"mumble-bar",style:{animationDelay:"0ms"}}),t.jsx("span",{className:"mumble-bar",style:{animationDelay:"150ms"}}),t.jsx("span",{className:"mumble-bar",style:{animationDelay:"300ms"}})]}),t.jsx("span",{className:"blur-[1px] select-none",children:e.length===1?`${e[0]} is thinking...`:`${e.length} people murmuring...`})]})}const P={sm:"w-7 h-7 text-xs",md:"w-10 h-10 text-sm",lg:"w-14 h-14 text-base"};function A({name:e,src:c,size:s="md",active:l=!1,className:a=""}){const r=e.split(" ").map(f=>f[0]).join("").slice(0,2).toUpperCase(),m=e.split("").reduce((f,o)=>f+o.charCodeAt(0),0)%40+15;return t.jsx("div",{className:["rounded-full flex items-center justify-center font-medium select-none","transition-shadow duration-[var(--duration-normal)]",P[s],l?"ring-2 ring-[var(--color-accent-amber)] shadow-[var(--shadow-glow)]":"",a].join(" "),style:c?void 0:{backgroundColor:`hsl(${m}, 40%, 35%)`,color:`hsl(${m}, 30%, 80%)`},title:e,children:c?t.jsx("img",{src:c,alt:e,className:"w-full h-full rounded-full object-cover"}):r})}function $({users:e,roomName:c}){return t.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 border-b border-[var(--color-bg-elevated)]",children:[c&&t.jsx("h2",{className:"font-display text-lg text-[var(--color-text-primary)] mr-auto",children:c}),t.jsxs("span",{className:"text-[var(--color-text-muted)] text-sm",children:[e.length," ",e.length===1?"person":"people"," here"]}),t.jsxs("div",{className:"flex -space-x-2",children:[e.slice(0,8).map(s=>t.jsx(A,{name:s.display_name,className:"ring-2 ring-[var(--color-bg-primary)]",size:"sm"},s.user_id)),e.length>8&&t.jsxs("span",{className:"text-[var(--color-text-muted)] text-xs ml-2 self-center",children:["+",e.length-8]})]})]})}function L({roomId:e,roomName:c}){const{messages:s,isLoading:l,sendMessage:a,removeMessage:r}=M(e),{presentUsers:m}=D(e),f=[];return t.jsxs("div",{className:"flex flex-col h-full animate-slide-in",children:[t.jsx($,{users:m,roomName:c}),l?t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsx("div",{className:"w-8 h-8 rounded-full animate-warm-pulse",style:{background:"radial-gradient(circle, var(--color-accent-amber), transparent 70%)"}})}):t.jsx(R,{messages:s,onMessageGone:r}),t.jsx(_,{typingUsers:f}),t.jsx(T,{onSend:a})]})}function H(){const{roomId:e}=w(),[c,s]=n.useState(null),[l,a]=n.useState("");return n.useEffect(()=>{e&&h.collection("rooms").getOne(e).then(s).catch(()=>a("Room not found"))},[e]),l?t.jsx(v,{children:t.jsx("div",{className:"flex items-center justify-center h-full text-[var(--color-alert-clay)]",children:l})}):!c||!e?t.jsx(v,{children:t.jsx("div",{className:"flex items-center justify-center h-full",children:t.jsx(N,{})})}):t.jsx(v,{children:t.jsx(L,{roomId:e,roomName:c.name})})}export{H as default};
//# sourceMappingURL=RoomPage-CVJrcVW7.js.map
