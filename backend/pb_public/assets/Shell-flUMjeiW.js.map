{"version":3,"file":"Shell-flUMjeiW.js","sources":["../../src/components/layout/RoomList.tsx","../../src/hooks/useReconnect.ts","../../src/components/layout/ConnectionIndicator.tsx","../../src/components/layout/Shell.tsx"],"sourcesContent":["import { useEffect, useState } from 'react';\r\nimport { NavLink } from 'react-router-dom';\r\nimport pb from '@/lib/pocketbase';\r\n\r\ninterface Room {\r\n  id: string;\r\n  name: string;\r\n  slug: string;\r\n  description: string;\r\n}\r\n\r\n/**\r\n * Room navigation sidebar.\r\n * Fetches rooms the user is a member of.\r\n */\r\nexport function RoomList() {\r\n  const [rooms, setRooms] = useState<Room[]>([]);\r\n\r\n  useEffect(() => {\r\n    async function fetchRooms() {\r\n      try {\r\n        // Fetch rooms the current user is a member of\r\n        const userId = pb.authStore.record?.id;\r\n        if (!userId) return;\r\n\r\n        const memberships = await pb\r\n          .collection('room_members')\r\n          .getFullList({\r\n            filter: `user = \"${userId}\"`,\r\n            expand: 'room',\r\n          });\r\n\r\n        const roomList = memberships\r\n          .map((m) => {\r\n            const expanded = m.expand as { room?: Room } | undefined;\r\n            return expanded?.room;\r\n          })\r\n          .filter((r): r is Room => !!r);\r\n\r\n        setRooms(roomList);\r\n      } catch {\r\n        // Will retry on reconnect\r\n      }\r\n    }\r\n\r\n    fetchRooms();\r\n  }, []);\r\n\r\n  return (\r\n    <nav className=\"flex flex-col h-full bg-[var(--color-bg-secondary)]\">\r\n      <div className=\"px-4 py-5\">\r\n        <h1 className=\"font-display text-xl text-[var(--color-accent-amber)]\">\r\n          Hearth\r\n        </h1>\r\n      </div>\r\n\r\n      <div className=\"flex-1 overflow-y-auto px-2 space-y-1\">\r\n        {rooms.length === 0 ? (\r\n          <p className=\"px-3 py-2 text-sm text-[var(--color-text-muted)]\">\r\n            No rooms yet\r\n          </p>\r\n        ) : (\r\n          rooms.map((room) => (\r\n            <NavLink\r\n              key={room.id}\r\n              to={`/room/${room.id}`}\r\n              className={({ isActive }) =>\r\n                [\r\n                  'block px-3 py-2 rounded-[var(--radius-md)] text-sm',\r\n                  'transition-colors duration-[var(--duration-fast)]',\r\n                  isActive\r\n                    ? 'bg-[var(--color-bg-elevated)] text-[var(--color-accent-amber)]'\r\n                    : 'text-[var(--color-text-secondary)] hover:bg-[var(--color-bg-primary)] hover:text-[var(--color-text-primary)]',\r\n                ].join(' ')\r\n              }\r\n            >\r\n              {room.name}\r\n            </NavLink>\r\n          ))\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"p-4 border-t border-[var(--color-bg-elevated)]\">\r\n        <button\r\n          onClick={() => pb.authStore.clear()}\r\n          className=\"text-xs text-[var(--color-text-muted)] hover:text-[var(--color-alert-clay)] transition-colors duration-[var(--duration-fast)]\"\r\n        >\r\n          Sign out\r\n        </button>\r\n      </div>\r\n    </nav>\r\n  );\r\n}\r\n","import { useEffect, useRef, useState, useCallback } from 'react';\r\nimport pb from '@/lib/pocketbase';\r\n\r\n/**\r\n * Handles SSE reconnect state synchronization.\r\n * On every PB_CONNECT after the first, re-fetches data to catch missed events.\r\n *\r\n * From R-004:\r\n * - PB_CONNECT fires on EVERY connection (including the first)\r\n * - Reconnect does NOT replay missed events\r\n * - SDK auto-reconnects with backoff: [200,300,500,1000,1200,1500,2000]ms\r\n */\r\nexport function useReconnect(onResync: () => void) {\r\n  const isFirstConnect = useRef(true);\r\n\r\n  useEffect(() => {\r\n    const unsubscribe = pb.realtime.subscribe('PB_CONNECT', async () => {\r\n      if (isFirstConnect.current) {\r\n        isFirstConnect.current = false;\r\n        return; // First connect — no resync needed\r\n      }\r\n\r\n      // Non-initial connect: we missed events during disconnection.\r\n      // Validate auth is still good\r\n      try {\r\n        await pb.collection('users').authRefresh();\r\n      } catch {\r\n        pb.authStore.clear();\r\n        return;\r\n      }\r\n\r\n      // Re-fetch current state\r\n      onResync();\r\n    });\r\n\r\n    return () => {\r\n      unsubscribe.then((fn) => fn());\r\n    };\r\n  }, [onResync]);\r\n}\r\n\r\n/**\r\n * Tracks connection state (connected / reconnecting / offline).\r\n * Uses PB_CONNECT and onDisconnect callbacks from R-004.\r\n */\r\nexport function useConnectionState() {\r\n  const [isConnected, setIsConnected] = useState(true);\r\n  const [isReconnecting, setIsReconnecting] = useState(false);\r\n\r\n  useEffect(() => {\r\n    pb.realtime.onDisconnect = () => {\r\n      setIsConnected(false);\r\n      setIsReconnecting(true);\r\n    };\r\n\r\n    const unsubscribe = pb.realtime.subscribe('PB_CONNECT', () => {\r\n      setIsConnected(true);\r\n      setIsReconnecting(false);\r\n    });\r\n\r\n    return () => {\r\n      unsubscribe.then((fn) => fn());\r\n    };\r\n  }, []);\r\n\r\n  const forceResync = useCallback(() => {\r\n    setIsReconnecting(true);\r\n  }, []);\r\n\r\n  return { isConnected, isReconnecting, forceResync };\r\n}\r\n","import { useConnectionState } from '@/hooks/useReconnect';\r\n\r\n/**\r\n * Top banner when SSE connection is lost (K-016).\r\n * Burnt clay color for visibility. Floats in.\r\n */\r\nexport function ConnectionIndicator() {\r\n  const { isConnected, isReconnecting } = useConnectionState();\r\n\r\n  if (isConnected) return null;\r\n\r\n  return (\r\n    <div className=\"fixed top-0 inset-x-0 bg-[var(--color-alert-clay)] text-[var(--color-text-primary)] text-center py-1.5 text-sm animate-float-in z-50\">\r\n      {isReconnecting ? 'Reconnecting...' : 'Offline'}\r\n    </div>\r\n  );\r\n}\r\n","import { type ReactNode } from 'react';\r\nimport { RoomList } from './RoomList';\r\nimport { ConnectionIndicator } from './ConnectionIndicator';\r\n\r\ninterface Props {\r\n  children: ReactNode;\r\n}\r\n\r\n/**\r\n * App shell — sidebar + main content area.\r\n * Mobile: single column (sidebar hidden). Tablet+: sidebar visible.\r\n * K-023: Mobile-first responsive layout.\r\n */\r\nexport function Shell({ children }: Props) {\r\n  return (\r\n    <>\r\n      <ConnectionIndicator />\r\n      <div className=\"flex h-screen bg-[var(--color-bg-primary)]\">\r\n        {/* Room sidebar — hidden on mobile, visible on md+ */}\r\n        <aside className=\"hidden md:flex md:w-64 lg:w-72 flex-col shrink-0\">\r\n          <RoomList />\r\n        </aside>\r\n\r\n        {/* Main content */}\r\n        <main className=\"flex-1 flex flex-col min-w-0\">\r\n          {children}\r\n        </main>\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n"],"names":["RoomList","rooms","setRooms","useState","useEffect","fetchRooms","userId","pb","roomList","m","r","jsxs","jsx","room","NavLink","isActive","useReconnect","onResync","isFirstConnect","useRef","unsubscribe","fn","useConnectionState","isConnected","setIsConnected","isReconnecting","setIsReconnecting","forceResync","useCallback","ConnectionIndicator","Shell","children","Fragment"],"mappings":"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"}